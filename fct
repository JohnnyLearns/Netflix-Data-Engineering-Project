-- fct_genome_scores
{{ config(materialized='table') }}

WITH src_scores AS (
    SELECT * FROM {{ ref('src_genome_score') }}
)

SELECT 
    movie_id,
    tag_id,
    ROUND(relevance, 4) AS relevance_score
FROM src_scores
WHERE relevance > 0

-- fct_ratings
{{ config(
    materialized='incremental',
    on_schema_change = 'fail'
    ) }}


SELECT 
    user_id,
    movie_id,
    rating,
    rating_timestamp
FROM src_ratings
WHERE rating IS NOT NULL

{% if is_incremental() %}
    AND rating_timestamp > (SELECT MAX(rating_timestamp) FROM {{ this }})
{% endif %}

