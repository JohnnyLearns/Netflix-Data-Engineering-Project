-- dim_genome_tags
{{ config(materialized='table') }}
WITH src_tags AS (
    SELECT * FROM {{ ref('src_genome_tags') }}
)

SELECT 
    tag_id,
    INITCAP(TRIM(tag)) AS tag_name
FROM src_tags

-- dim_movies_with_tags
{{
    config(
        materialized = 'ephemeral'
    )
}}

WITH movies AS (
    SELECT * FROM {{ ref("dim_movies") }}
),
tags AS (
    SELECT * FROM {{ ref("dim_genome_tags") }}
),
scores AS (
    SELECT * FROM {{ ref("fct_genome_scores") }}
)

SELECT 
    m.movie_id,
    m.movie_title,
    m.genres,
    t.tag_name,
    s.relevance_score
FROM movies m
LEFT JOIN scores s ON m.movie_id = s.movie_id
LEFT JOIN tags t ON t.tag_id = s.tag_id

-- dim_movies
{{ config(materialized='table') }}
WITH src_movies AS (
    SELECT * FROM {{ ref('src_movies') }}
)

SELECT
    movie_id,
    INITCAP(TRIM(title)) AS movie_title,
    SPLIT(genres, '|') AS genre_array,
    genres
FROM src_movies

-- dim_users
{{ config(materialized='table') }}
WITH ratings AS (
    SELECT DISTINCT user_id FROM {{ ref('src_ratings') }}
),

tags AS (
    SELECT DISTINCT user_id FROM {{ ref('src_tags') }}
)
SELECT DISTINCT user_id
FROM (
    SELECT * FROM ratings
    UNION
    SELECT * FROM tags
)
